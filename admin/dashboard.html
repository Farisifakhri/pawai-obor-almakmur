<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Admin Dashboard - Monitoring & Juara</title>
</head>
<body>
    <div class="container" style="max-width: 950px;">
        <h1>ğŸ“Š Monitoring & Klasemen Akhir</h1>
        
        <div class="card" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="text-align:center">Rank</th>
                        <th>Nama Kelompok</th>
                        <th style="text-align:center">Pos 1</th>
                        <th style="text-align:center">Pos 2</th>
                        <th style="text-align:center">Pos 3</th>
                        <th style="text-align:center">Pos 4</th>
                        <th style="text-align:center">Pos 5</th>
                        <th style="text-align:center">Rata-rata</th>
                    </tr>
                </thead>
                <tbody id="admin-body">
                    </tbody>
            </table>
        </div>

        <div id="winner-summary"></div>

        <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn" onclick="window.location.href='../index.html'">Cek Leaderboard Publik</button>
            <button class="btn" style="background: #95a5a6;" onclick="location.reload()">Refresh Data</button>
        </div>

        <button onclick="handleLogout()" style="margin-top:30px; background:none; border:none; color:red; cursor:pointer; width:100%; font-weight:600;">ğŸšª Logout Sistem</button>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        protectPage().then(async () => {
            // 1. Ambil data leaderboard (Otomatis urut nilai tertinggi)
            const { data: leaderboardData, error: lError } = await supabaseClient
                .from('leaderboard')
                .select('*')
                .order('nilai_akhir', { ascending: false });

            // 2. Ambil detail skor per pos
            const { data: allScores, error: sError } = await supabaseClient
                .from('skor_pos')
                .select('*');

            // 3. Ambil data Juara Spesialis Pos (dari View SQL yang kita buat)
            const { data: posWinners } = await supabaseClient
                .from('juara_per_pos')
                .select('*');

            if (lError || sError) {
                console.error("Gagal ambil data:", lError || sError);
                return;
            }

            const tbody = document.getElementById('admin-body');
            
            // Render Tabel Monitoring
            tbody.innerHTML = leaderboardData.map((peserta, index) => {
                const posScores = [1, 2, 3, 4, 5].map(idPos => {
                    const match = allScores.find(s => Number(s.id_peserta) === Number(peserta.id_peserta) && s.id_pos === idPos);
                    return match ? match.nilai : '<span style="color:#ccc">-</span>';
                });

                // Emoji Rank
                let rankIcon = index + 1;
                if(index === 0) rankIcon = 'ğŸ¥‡';
                if(index === 1) rankIcon = 'ğŸ¥ˆ';
                if(index === 2) rankIcon = 'ğŸ¥‰';

                return `
                    <tr>
                        <td style="text-align:center; font-weight:bold; font-size:1.1rem;">${rankIcon}</td>
                        <td><b>${peserta.nama_kelompok}</b></td>
                        <td style="text-align:center">${posScores[0]}</td>
                        <td style="text-align:center">${posScores[1]}</td>
                        <td style="text-align:center">${posScores[2]}</td>
                        <td style="text-align:center">${posScores[3]}</td>
                        <td style="text-align:center">${posScores[4]}</td>
                        <td style="font-weight:700; color:var(--dark-green); text-align:center; background:#f0fff0;">
                            ${parseFloat(peserta.nilai_akhir).toFixed(2)}
                        </td>
                    </tr>
                `;
            }).join('');

            // Render Ringkasan Juara Harapan & Spesialis
            const summaryDiv = document.getElementById('winner-summary');
            summaryDiv.innerHTML = `
                <div class="card" style="margin-top:20px; border-left: 8px solid #2ecc71;">
                    <h2 style="text-align:left; margin-bottom:10px;">ğŸ‘‘ Ringkasan Pemenang</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color:var(--dark-green)">ğŸ† Juara Harapan:</h4>
                            <p>Harapan 1: <b>${leaderboardData[3]?.nama_kelompok || '-'}</b></p>
                            <p>Harapan 2: <b>${leaderboardData[4]?.nama_kelompok || '-'}</b></p>
                            <p>Harapan 3: <b>${leaderboardData[5]?.nama_kelompok || '-'}</b></p>
                        </div>
                        <div>
                            <h4 style="color:var(--dark-green)">ğŸš© Spesialis Pos (Nilai Tertinggi):</h4>
                            ${posWinners ? posWinners.map(w => `
                                <p>Pos ${w.id_pos}: <b>${w.nama_kelompok}</b> (${w.skor_tertinggi})</p>
                            `).join('') : '<p>Belum ada data</p>'}
                        </div>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>