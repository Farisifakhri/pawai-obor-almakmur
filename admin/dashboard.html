<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../assets/images/logo_dkm.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <title>Admin - Monitoring Pawai</title>
</head>
<body>
    <div class="screen-wrapper" style="padding-top: 20px; justify-content: flex-start;">
        <div class="container" style="max-width: 1200px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: var(--primary-dark); font-weight: 800;">üéõÔ∏è Control Panel Admin</h1>
                <p style="color: #636e72;">Monitoring Real-time & Manajemen Data (6 Juri)</p>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:25px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-premium" onclick="exportToExcel()" style="width: auto; background: #27ae60;">
                    üìä Download Excel Laporan
                </button>
                <button class="btn-premium" onclick="location.reload()" style="width: auto; background: #2980b9;">
                    üîÑ Refresh Data
                </button>
                <button class="btn-premium" onclick="resetData()" style="width: auto; background: #c0392b;">
                    ‚ö†Ô∏è Hapus Data Simulasi
                </button>
            </div>

            <div class="card" style="padding: 10px;">
                <div class="table-wrapper custom-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:center; width: 50px;">Rank</th>
                                <th>Nama Kelompok</th>
                                <th style="text-align:center">Pos 1 (Avg)</th>
                                <th style="text-align:center">Pos 2 (Avg)</th>
                                <th style="text-align:center">Pos 3 (Avg)</th>
                                <th style="text-align:center">Pos 4 (Avg)</th>
                                <th style="text-align:center; background: #f0fdf4;">Total Skor (/400)</th>
                                <th style="text-align:center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-body">
                            <tr><td colspan="8" align="center" style="padding:20px;">‚è≥ Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        let leaderboardData = []; 
        let allScores = [];

        // 1. Fungsi Utama: Load Data Dashboard
        protectPage().then(async () => {
            loadDashboard();
        });

        async function loadDashboard() {
            // Ambil data peserta & skor
            const { data: pesertasi } = await supabaseClient.from('peserta').select('*');
            const { data: sc } = await supabaseClient.from('skor_pos').select('*');
            
            allScores = sc || [];
            
            // Hitung skor di sisi client agar sinkron dengan rumus 6 juri
            leaderboardData = pesertasi.map(p => {
                let totalFinal400 = 0;
                let posAvgs = [];

                [1, 2, 3, 4].forEach(posId => {
                    const scores = allScores.filter(s => s.id_peserta === p.id && s.id_pos === posId);
                    if (scores.length > 0) {
                        const sum = scores.reduce((acc, curr) => acc + Number(curr.nilai), 0);
                        const avg = sum / 6; // RUMUS BARU: Dibagi 6
                        totalFinal400 += avg;
                        posAvgs.push(avg.toFixed(1));
                    } else {
                        posAvgs.push("-");
                    }
                });

                return { ...p, posAvgs, nilai_akhir: totalFinal400 };
            }).sort((a, b) => b.nilai_akhir - a.nilai_akhir); // Urutkan rank

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('admin-body');
            tbody.innerHTML = leaderboardData.map((p, i) => `
                <tr>
                    <td align="center">
                        <span style="background:${i<3?'#f1c40f':'#dfe6e9'}; padding:5px 10px; border-radius:50%; font-weight:bold; font-size:12px;">
                            ${i+1}
                        </span>
                    </td>
                    <td style="font-weight:700;">${p.nama_kelompok}</td>
                    <td align="center">${p.posAvgs[0]}</td>
                    <td align="center">${p.posAvgs[1]}</td>
                    <td align="center">${p.posAvgs[2]}</td>
                    <td align="center">${p.posAvgs[3]}</td>
                    <td align="center" style="background:#f0fff0; font-weight:800; color:#27ae60; font-size:16px;">
                        ${p.nilai_akhir.toFixed(2)}
                    </td>
                    <td align="center">
                        <button onclick="openEdit(${p.id}, '${p.nama_kelompok}')" 
                                style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:12px;">
                            ‚úèÔ∏è Edit
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 2. Fungsi Edit Data (Dengan Validasi Juri 1-6)
        async function openEdit(id, nama) {
            const p = prompt(`Edit Nilai: ${nama}\n\nMasukkan POS (1-4):`);
            if (!p || p < 1 || p > 4) return;

            const j = prompt(`Masukkan JURI (1-6):`);
            if (!j || j < 1 || j > 6) {
                alert("‚ùå Error: Juri hanya boleh 1 sampai 6!");
                return;
            }

            const n = prompt(`Masukkan NILAI BARU (0-100):`);
            if (n === null || isNaN(n) || n < 0 || n > 100) {
                alert("‚ùå Error: Nilai harus angka 0-100!");
                return;
            }

            const { error } = await supabaseClient.from('skor_pos').upsert({
                id_peserta: id,
                id_pos: parseInt(p),
                id_juri: parseInt(j),
                nilai: parseInt(n)
            }, { onConflict: 'id_peserta, id_pos, id_juri' });

            if (error) alert("Gagal: " + error.message);
            else {
                alert("‚úÖ Nilai berhasil diperbarui!");
                loadDashboard(); // Refresh tabel tanpa reload halaman
            }
        }

        // 3. Fungsi Export Excel (Looping 6 Juri)
        function exportToExcel() {
            const dataExport = leaderboardData.map((p, i) => {
                const row = { 
                    "Ranking": i + 1, 
                    "Nama Kelompok": p.nama_kelompok 
                };

                // Loop Pos & Juri
                [1, 2, 3, 4].forEach(pos => {
                    let sumPos = 0;
                    // HANYA SAMPAI 6 JURI
                    [1, 2, 3, 4, 5, 6].forEach(jur => {
                        const s = allScores.find(x => x.id_peserta === p.id && x.id_pos === pos && x.id_juri === jur);
                        const val = s ? Number(s.nilai) : 0;
                        row[`P${pos}_J${jur}`] = val; // Kolom P1_J1, P1_J2, dst.
                        sumPos += val;
                    });
                    row[`Rata2_Pos${pos}`] = (sumPos / 6).toFixed(2);
                });

                row["TOTAL SKOR AKHIR"] = p.nilai_akhir.toFixed(2);
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap_Nilai_Final");
            XLSX.writeFile(wb, "Laporan_Pawai_AlMamur_Final.xlsx");
        }

        // 4. Fungsi Reset Data (Hapus Semua Nilai)
        async function resetData() {
            if (confirm("‚ö†Ô∏è PERINGATAN KERAS!\n\nApakah Anda yakin ingin MENGHAPUS SEMUA DATA NILAI?\nData simulasi akan hilang permanen. Gunakan tombol ini hanya sebelum acara dimulai.")) {
                const code = prompt("Ketik 'HAPUS' untuk konfirmasi:");
                if (code === 'HAPUS') {
                    // Menghapus semua baris di tabel skor_pos
                    const { error } = await supabaseClient.from('skor_pos').delete().gt('id', 0);
                    
                    if (error) alert("Gagal reset: " + error.message);
                    else {
                        alert("‚úÖ Data simulasi BERHASIL DIHAPUS. Sistem siap digunakan!");
                        location.reload();
                    }
                } else {
                    alert("Kode konfirmasi salah. Batal menghapus.");
                }
            }
        }
    </script>
</body>
</html>