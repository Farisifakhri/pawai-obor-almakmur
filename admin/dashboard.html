<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>Admin - Monitoring & Edit</title>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Control Panel Admin</h1>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn" onclick="exportToExcel()" style="background:#27ae60;">ðŸ“¥ Excel</button>
            <button class="btn" onclick="location.reload()" style="background:#3498db;">ðŸ”„ Refresh</button>
        </div>

        <div class="card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align:center">Rank</th>
                            <th>Nama Kelompok</th>
                            <th style="text-align:center">P1 (Avg)</th>
                            <th style="text-align:center">P2 (Avg)</th>
                            <th style="text-align:center">P3 (Avg)</th>
                            <th style="text-align:center">P4 (Avg)</th>
                            <th style="text-align:center">Total 12J</th>
                            <th style="text-align:center">Final Avg</th>
                            <th style="text-align:center">Edit</th>
                        </tr>
                    </thead>
                    <tbody id="admin-body"></tbody>
                    <tfoot id="admin-footer" style="background:#f8f9fa; font-weight:800;"></tfoot>
                </table>
            </div>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        let leaderboardData = [], allScores = [];

        protectPage().then(async () => {
            const { data: ld } = await supabaseClient.from('leaderboard').select('*').order('nilai_akhir', { ascending: false });
            const { data: sc } = await supabaseClient.from('skor_pos').select('*');
            leaderboardData = ld || []; allScores = sc || [];
            
            let colTotals = [0,0,0,0], colCounts = [0,0,0,0];
            const tbody = document.getElementById('admin-body');

            
            tbody.innerHTML = leaderboardData.map((p, i) => {
            let final400 = 0;
            const posAvgs = [1,2,3,4].map((posId) => {
            const scores = allScores.filter(s => Number(s.id_peserta) === Number(p.id_peserta) && s.id_pos === posId);
            if (scores.length > 0) {
            const avg = scores.reduce((a, c) => a + Number(c.nilai), 0) / 8; // Rata-rata 8 juri
            final400 += avg;
            return avg.toFixed(1);
            }
            return "0.0";
            });

            return `
            <tr>
            <td align="center">${i+1}</td>
            <td><b>${p.nama_kelompok}</b></td>
            <td align="center">${posAvgs[0]}</td><td align="center">${posAvgs[1]}</td>
            <td align="center">${posAvgs[2]}</td><td align="center">${posAvgs[3]}</td>
            <td align="center" style="background:#f0fff0; font-weight:800;">${final400.toFixed(2)} / 400</td>
            <td align="center"><button onclick="openEdit(...)">Edit</button></td>
            </tr>`;
            });

            document.getElementById('admin-footer').innerHTML = `
                <tr>
                    <td colspan="2" align="right">RATA-RATA GLOBAL POS:</td>
                    <td align="center">${(colTotals[0]/(colCounts[0]||1)).toFixed(2)}</td>
                    <td align="center">${(colTotals[1]/(colCounts[1]||1)).toFixed(2)}</td>
                    <td align="center">${(colTotals[2]/(colCounts[2]||1)).toFixed(2)}</td>
                    <td align="center">${(colTotals[3]/(colCounts[3]||1)).toFixed(2)}</td>
                    <td colspan="3"></td>
                </tr>`;
        });

        async function openEdit(id, nama) {
    // Diubah menjadi 1-4 dan 1-8 sesuai jumlah juri baru
    const p = prompt(`Edit RT: ${nama}\nMasukkan POS (1-4):`); 
    if(!p) return;
    
    const j = prompt(`Masukkan JURI (1-8):`); 
    if(!j) return;
    
    const n = prompt(`Masukkan NILAI BARU (0-100):`); 
    if(n === null) return;
    
    const { error } = await supabaseClient.from('skor_pos').upsert({ 
        id_peserta: id, 
        id_pos: parseInt(p), 
        id_juri: parseInt(j), 
        nilai: parseInt(n) 
    }, { onConflict: 'id_peserta, id_pos, id_juri' });

    if(error) alert("Gagal: " + error.message); 
    else { alert("âœ… Data Juri Berhasil Diperbarui!"); location.reload(); }
}

function exportToExcel() {
    const d = leaderboardData.map((p, i) => {
        const r = { "Rank": i+1, "Kelompok": p.nama_kelompok };
        let finalScore400 = 0;

        // Loop melalui 4 POS
        [1,2,3,4].forEach(pos => {
            let posSum = 0;
            // Loop melalui 8 JURI per POS
            [1,2,3,4,5,6,7,8].forEach(jur => {
                const s = allScores.find(x => 
                    Number(x.id_peserta) === Number(p.id_peserta) && 
                    x.id_pos === pos && 
                    x.id_juri === jur
                );
                const n = s ? Number(s.nilai) : 0;
                
                // Menambahkan kolom detail per juri ke Excel
                r[`P${pos} J${jur}`] = n; 
                posSum += n;
            });
            // Hitung rata-rata per pos (Max 100) dan tambahkan ke total akhir
            finalScore400 += (posSum / 8);
        });

        r["Total Skor (/400)"] = finalScore400.toFixed(2);
        return r;
    });

    // Proses pembuatan file Excel
    const ws = XLSX.utils.json_to_sheet(d); 
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan Final");
    
    // Nama file disesuaikan dengan sistem baru
    XLSX.writeFile(wb, "Laporan_Pawai_32Juri_Final.xlsx");
}
    </script>
</body>
</html>