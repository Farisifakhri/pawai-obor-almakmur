<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Input Nilai - Pos Pawai</title>
</head>
<body>
    <div class="login-screen">
        <div class="card login-card" style="max-width: 550px;">
            <div style="text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                <div id="pos-badge" style="font-weight: 800; color: var(--primary-dark); letter-spacing: 1px; font-size: 0.9rem; text-transform: uppercase;">MEMUAT...</div>
                <h2 style="margin-top: 5px; font-weight: 800;">Input Kolektif 8 Juri</h2>
            </div>

            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 14px;">
                <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 5px;">
                    <span style="color: #636e72;">PROGRES RT SELESAI</span>
                    <span id="stat-progress-text">0/25</span>
                </div>
                <div class="progress-container"><div id="stat-progress-bar" class="progress-bar"></div></div>
            </div>

            <form id="pos-form">
                <div class="form-group">
                    <label>üîç Cari RT/RW</label>
                    <input type="text" id="search-kelompok" placeholder="Cari..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label>üë• Pilih Kelompok</label>
                    <select id="kelompok" size="5" required></select>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
                    <script>
                        for(let i=1; i<=8; i++) {
                            document.write(`
                                <div style="text-align:center;">
                                    <label style="font-size:10px; font-weight:700; color:#636e72;">J${i}</label>
                                    <input type="number" id="skor${i}" min="0" max="100" placeholder="0" required 
                                    style="font-size:1.1rem; text-align:center; padding:8px; font-weight:800; border:2px solid #edf2f7; border-radius:12px; color:var(--primary-dark);">
                                </div>
                            `);
                        }
                    </script>
                </div>
                <button class="btn-premium" type="submit" id="btn-submit" style="margin-top:25px;">
                    <span>üöÄ SIMPAN 8 NILAI JURI</span>
                </button>
            </form>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; text-align: center;">
                <button onclick="handleLogout()" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-weight: 700; font-size: 11px; text-transform: uppercase;">
                    üö™ Keluar Sistem
                </button>
            </div>
        </div>
    </div>

    <div id="toast" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2d3436; color:white; padding:12px 25px; border-radius:50px; display:none; z-index:1000; box-shadow: var(--shadow);"></div>

    <script src="../assets/js/app.js"></script>
    <script>
        let daftarPeserta = [], pId;

        function showToast(msg, err=false) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.background = err ? '#e74c3c' : '#2d3436';
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
        }

        async function updateProgress() {
            const { data } = await supabaseClient.from('skor_pos').select('id_peserta').eq('id_pos', pId);
            if (data) {
                const unique = new Set(data.map(item => item.id_peserta));
                const percent = (unique.size / (daftarPeserta.length || 25)) * 100;
                document.getElementById('stat-progress-bar').style.width = percent + '%';
                document.getElementById('stat-progress-text').innerText = `${unique.size}/${daftarPeserta.length || 25}`;
            }
        }

        protectPage().then(async (session) => {
            pId = session.user.user_metadata.pos_id;
            document.getElementById('pos-badge').innerText = `üö© OPERATOR POS ${pId}`;
            const { data } = await supabaseClient.from('peserta').select('*').order('nama_kelompok');
            daftarPeserta = data || []; 
            renderKelompok(daftarPeserta); 
            updateProgress();

            document.getElementById('search-kelompok').oninput = (e) => {
                const k = e.target.value.toLowerCase();
                renderKelompok(daftarPeserta.filter(p => p.nama_kelompok.toLowerCase().includes(k)));
            };

            document.getElementById('pos-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-submit');
                const idK = parseInt(document.getElementById('kelompok').value);
                btn.disabled = true; btn.innerText = "‚è≥ Menyimpan...";

                const scores = [];
                for(let i=1; i<=8; i++) {
                    scores.push({ 
                        id_peserta: idK, 
                        id_pos: pId, 
                        id_juri: i, 
                        nilai: parseInt(document.getElementById(`skor${i}`).value) 
                    });
                }

                const { error } = await supabaseClient.from('skor_pos').upsert(scores, { onConflict: 'id_peserta, id_pos, id_juri' });
                
                btn.disabled = false; btn.innerText = "üöÄ SIMPAN 8 NILAI JURI";
                
                if (error) {
                    showToast("‚ùå Gagal: " + error.message, true);
                } else { 
                    showToast("‚úÖ Berhasil disimpan!"); 
                    e.target.reset(); 
                    renderKelompok(daftarPeserta); 
                    updateProgress();
                    document.getElementById('search-kelompok').focus();
                }
            };
        });

        function renderKelompok(d) {
            document.getElementById('kelompok').innerHTML = d.map(p => `<option value="${p.id}" style="padding:10px;">${p.nama_kelompok}</option>`).join('');
        }
    </script>
</body>
</html>